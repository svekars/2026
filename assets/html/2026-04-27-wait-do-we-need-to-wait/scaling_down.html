<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Forcing: Scaling Down</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg-app: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-subtle: #e5e7eb;
            
            --color-question: #f59e0b;
            --color-model: #8b5cf6;
            --color-think: #3b82f6;
            --color-wait: #ef4444;
            --color-answer: #10b981;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);

            --header-height: auto;
            --spacing-unit: 1rem;

            /* Semantic Colors for Light Mode */
            --bg-input: #f8fafc;
            --bg-header-stream: #f9fafb;
            --bg-node-question: #fffbeb;
            --bg-node-model: #f5f3ff;
            
            --bg-stream-tag: #f3f4f6;
            
            --bg-stream-content: #eff6ff;
            --border-stream-content: #bfdbfe;
            --text-stream-content-title: #1e3a8a;
            --text-stream-content-meta: #60a5fa;
            
            --bg-stream-wait: #fee2e2;
            --border-stream-wait: #fca5a5;
            --text-stream-wait: #991b1b;
            
            --bg-stream-answer: #ecfdf5;
            --border-stream-answer: #6ee7b7;
            --text-stream-answer: #064e3b;
            --text-stream-answer-label: #059669;
            
            --bg-badge: #d1fae5;
            --text-badge: #065f46;

            --slider-track: #e2e8f0;
            --slider-marker: #cbd5e1;
            
            --grid-dot: #e5e7eb;
            --tooltip-bg: #1f2937;
            --tooltip-text: #ffffff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-app: #0f172a;
                --bg-card: #1e293b;
                --text-main: #f1f5f9;
                --text-muted: #94a3b8;
                --border-subtle: #334155;
                
                --bg-input: #1e293b; /* Same as card or slightly lighter/darker */
                --bg-header-stream: #0f172a;
                
                --bg-node-question: #451a03;
                --bg-node-model: #2e1065;
                
                --bg-stream-tag: #334155;
                
                --bg-stream-content: #172554;
                --border-stream-content: #1e40af;
                --text-stream-content-title: #dbeafe;
                --text-stream-content-meta: #60a5fa;
                
                --bg-stream-wait: #450a0a;
                --border-stream-wait: #991b1b;
                --text-stream-wait: #fecaca;
                
                --bg-stream-answer: #064e3b;
                --border-stream-answer: #059669;
                --text-stream-answer: #d1fae5;
                --text-stream-answer-label: #34d399;
                
                --bg-badge: #064e3b;
                --text-badge: #d1fae5;

                --slider-track: #334155;
                --slider-marker: #475569;
                
                --grid-dot: #334155;
                --tooltip-bg: #f8fafc;
                --tooltip-text: #0f172a;
                
                --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
                --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4);
                --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4);
            }
            
            .budget-integrated {
                background: #0f172a !important; /* Override light mode specific bg */
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Responsive scaling for smaller screens */
        @media (max-width: 1024px) {
            html { font-size: 14px; }
            :root { --spacing-unit: 0.75rem; }
        }

        @media (max-width: 640px) {
            html { font-size: 12px; }
            :root { --spacing-unit: 0.5rem; }
        }

        /* Header & Controls */
        .app-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit);
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .budget-integrated {
            flex: 1;
            max-width: 400px;
            background: var(--bg-input);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
        }
        
        /* Tooltip Styles */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: var(--tooltip-bg);
            color: var(--tooltip-text);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            width: max-content;
            max-width: 250px;
            z-index: 9999;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            box-shadow: var(--shadow-lg);
            line-height: 1.4;
            pointer-events: none;
            font-weight: 500;
            white-space: normal;
        }

        /* Specific fix for slider tooltips to ensure they show up */
        .step-label[data-tooltip]:hover::after {
            bottom: 100%;
            top: auto;
            margin-top: 0;
            margin-bottom: 8px;
        }

        .budget-header-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .budget-track {
            height: 8px;
            background: var(--slider-track);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .budget-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-think), var(--color-model));
            width: 0%;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px;
        }
        
        .budget-limit-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ef4444;
            left: 70%; /* 1024 out of ~1450 max scale */
            z-index: 2;
        }
        
        .budget-status-text {
            color: var(--color-wait);
            font-weight: 700;
            margin-right: auto;
            margin-left: 1rem;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }
        .budget-status-text.show { opacity: 1; }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 0.25rem;
        }

        h1 span { color: var(--color-wait); } /* Red/Orange for Scaling Down context */

        .subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .subtitle::before {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--color-wait);
        }

        .controls-row {
            display: flex;
            gap: calc(var(--spacing-unit) * 1.5);
            align-items: center;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        button {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
            white-space: nowrap;
        }
        
        button svg {
            width: 1rem;
            height: 1rem;
        }

        button:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        button.primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        button.primary:hover {
            background: var(--primary-hover);
            color: white;
        }

        /* Slider */
        .slider-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 150px; /* Prevent getting too small */
        }

        .slider-track-container {
            position: relative;
            height: 24px;
            display: flex;
            align-items: center;
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
            position: relative;
            z-index: 2;
            cursor: pointer;
        }

        input[type=range]:focus { outline: none; }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: var(--slider-track);
            border-radius: 3px;
        }

        input[type=range]::-webkit-slider-thumb {
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -6px;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: var(--primary-hover);
        }

        .step-markers {
            position: absolute;
            top: 9px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            padding: 0 9px; /* Half thumb width */
            z-index: 1;
        }

        .marker {
            width: 6px;
            height: 6px;
            background: var(--slider-marker);
            border-radius: 50%;
        }

        .step-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 2px;
            margin-top: 4px;
        }

        .step-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }
        
        .step-label:hover { color: var(--primary); font-weight: 600; }
        .step-label.active { color: var(--primary); font-weight: 700; }

        /* Main Canvas */
        .main-canvas {
            flex: 1;
            padding: calc(var(--spacing-unit) * 1.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-y: auto;
            position: relative;
            background-image: radial-gradient(var(--grid-dot) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Budget Meter removed from canvas styles */

        /* Process Flow */
        .process-flow {
            display: flex;
            align-items: flex-start;
            gap: calc(var(--spacing-unit) * 2);
            max-width: 1000px;
            width: 100%;
            justify-content: center;
            padding-top: 1rem;
        }

        /* Nodes */
        .node {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            min-width: 140px;
            position: relative;
            transition: all 0.3s;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .node[data-tooltip] {
            cursor: help;
        }

        .node.visible { opacity: 1; transform: translateY(0); }

        .node-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .node-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        .node-question .node-icon { background: var(--bg-node-question); color: var(--color-question); }
        .node-model .node-icon { background: var(--bg-node-model); color: var(--color-model); }

        /* Connection Arrows */
        .connection {
            align-self: flex-start;
            margin-top: 2.5rem; /* Align with center of nodes */
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.3s 0.1s;
        }
        .connection.visible { opacity: 1; }

        /* Output Stream Area */
        .output-stream-container {
            flex: 1;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-subtle);
            min-height: 300px;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .output-stream-container.final-state {
            border-color: var(--color-answer);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2), var(--shadow-lg);
        }

        .stream-header {
            padding: 1rem;
            background: var(--bg-header-stream);
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .generated-badge {
            background: var(--bg-badge);
            color: var(--text-badge);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .generated-badge.visible { opacity: 1; }

        .stream-content {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
            flex: 1;
        }

        /* Stream Items */
        .stream-item {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            animation: slideIn 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: 1px solid transparent;
            position: relative;
            cursor: default;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .item-tag {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            font-size: 0.8rem;
            background: var(--bg-stream-tag);
            align-self: flex-start;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .item-content {
            background: var(--bg-stream-content);
            border: 1px solid var(--border-stream-content);
            color: var(--text-stream-content-title);
        }
        
        .item-content .meta {
            display: block;
            font-size: 0.75rem;
            margin-top: 4px;
            color: var(--text-stream-content-meta);
            font-weight: 600;
        }

        .item-wait {
            background: var(--bg-stream-wait);
            border: 1px dashed var(--border-stream-wait);
            color: var(--text-stream-wait);
            text-align: center;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            padding: 0.5rem;
        }
        
        .item-answer {
            background: var(--bg-stream-answer);
            border: 1px solid var(--border-stream-answer);
            color: var(--text-stream-answer);
        }
        
        .item-answer .label {
            font-weight: 700;
            font-size: 0.75rem;
            color: var(--text-stream-answer-label);
            text-transform: uppercase;
            margin-bottom: 4px;
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .process-flow { flex-direction: column; align-items: center; gap: 0; padding-top: 0; }
            .connection { display: none; }
            .node { display: none; } /* Hide nodes on mobile as requested */
            .node.visible { display: none; } /* Ensure they stay hidden even if JS toggles them */
            
            .output-stream-container { 
                width: 100%; 
                max-width: 100%; 
                min-height: 60vh; /* Use more vertical space */
                border-radius: 0; /* Flatten edges for cleaner mobile look */
                border-left: none;
                border-right: none;
                box-shadow: none;
            }
            
            .header-top { flex-direction: column; align-items: stretch; gap: 1rem; }
            .budget-integrated { max-width: 100%; }
            .controls-row { flex-direction: column; align-items: stretch; width: 100%; gap: 1rem; }
            .btn-group { justify-content: center; }
            .app-header { padding: 1rem; }
            .main-canvas { padding: 0; background-image: none; } /* Simplify bg on mobile */
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="header-top">
            <div>
                <h1>Budget Forcing: <span>Scaling Down</span></h1>
                <div class="subtitle" id="subtitle" data-tooltip="Shows the current stage of the generation process">Initializing...</div>
            </div>
            
            <div class="budget-integrated" data-tooltip="Tracks token usage against the forced budget limit">
                <div class="budget-header-compact">
                    <span>BUDGET USAGE</span>
                    <span id="budgetStatusText" class="budget-status-text"></span>
                    <span id="budgetNumerical" style="font-family: 'JetBrains Mono', monospace;">0 / 1024</span>
                </div>
                <div class="budget-track">
                    <div class="budget-fill" id="budgetFill"></div>
                    <div class="budget-limit-marker" title="Maximum Limit"></div>
                </div>
            </div>
        </div>

        <div class="controls-row">
            <div class="btn-group">
                <button class="primary" id="playPauseBtn" onclick="togglePlayPause()" data-tooltip="Start/Pause the animation">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    Start
                </button>
                <button id="resetBtn" onclick="resetDemo()" data-tooltip="Reset animation to beginning">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 12"></path></svg>
                    Reset
                </button>
            </div>
            
            <div class="slider-wrapper">
                <div class="slider-track-container">
                    <div class="step-markers" id="stepMarkers"></div>
                    <input type="range" id="progressSlider" min="0" step="1" value="0" oninput="seek(this.value)">
                </div>
                <div class="step-labels" id="stepLabels"></div>
            </div>
        </div>
    </div>

    <div class="main-canvas">
        <!-- Flow Diagram -->
        <div class="process-flow">
            <!-- Question Node -->
            <div class="node node-question" id="nodeQuestion" data-tooltip="The input prompt from the user">
                <div class="node-icon">?</div>
                <div class="node-label">User Query</div>
            </div>

            <div class="connection" id="conn1">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14m-7-7 7 7-7 7"/></svg>
            </div>

            <!-- Model Node -->
            <div class="node node-model" id="nodeModel" data-tooltip="The AI model processing the request">
                <div class="node-icon">AI</div>
                <div class="node-label">Model</div>
            </div>

            <div class="connection" id="conn2">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14m-7-7 7 7-7 7"/></svg>
            </div>

            <!-- Output Stream -->
            <div class="output-stream-container" id="outputContainer">
                <div class="stream-header">
                    <span>Generation Stream</span>
                    <span class="generated-badge" id="finalBadge">COMPLETE</span>
                </div>
                <div class="stream-content" id="streamContent">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data & Config
        const BUDGET_LIMIT = 1024;
        const SCALE_MAX = 1450; // Use for visualization scaling
        
        const stages = [
            {
                iteration: "Step 1 - Initial generation",
                description: "The model generates a long chain of thought naturally.",
                budgetCheckText: "",
                tokensUsed: 1450, // Over budget
                showQuestion: true,
                content: [
                    { type: 'tag', text: '<think>' },
                    { type: 'content', title: 'Deep Reasoning', tokens: 1450, tooltip: "Model generates extensive reasoning" },
                    { type: 'tag', text: '</think>' },
                    { type: 'answer', title: 'Original Final Answer', tooltip: "Answer generated with full context" }
                ],
                isComplete: false
            },
            {
                iteration: "Step 2 - Budget checking",
                description: "System checks if token count exceeds the maximum budget.",
                budgetCheckText: "1450 > 1024",
                tokensUsed: 1450,
                showQuestion: true,
                content: [
                    { type: 'tag', text: '<think>' },
                    { type: 'content', title: 'Deep Reasoning', tokens: 1450, tooltip: "Tokens exceed limit" },
                    { type: 'tag', text: '</think>' },
                    { type: 'answer', title: 'Original Final Answer' }
                ],
                isComplete: false
            },
            {
                iteration: "Step 3 - Truncation",
                description: "System truncates the thinking content to fit the budget.",
                budgetCheckText: "Truncate",
                tokensUsed: 1024,
                showQuestion: true,
                content: [
                    { type: 'tag', text: '<think>' },
                    { type: 'content', title: 'Truncated Reasoning', tokens: 1024, tooltip: "Content cut off at limit" },
                    { type: 'wait', text: 'TRUNCATED', tooltip: "Excess tokens removed" }
                ],
                isComplete: false
            },
            {
                iteration: "Step 4 - Force Completion",
                description: "System forces the end of thinking and prompts for answer.",
                budgetCheckText: "Force End",
                tokensUsed: 1024,
                showQuestion: true,
                content: [
                    { type: 'tag', text: '<think>' },
                    { type: 'content', title: 'Truncated Reasoning', tokens: 1024 },
                    { type: 'tag', text: '</think>' },
                    { type: 'tag', text: 'So, the final answer is' },
                ],
                isComplete: false
            },
            {
                iteration: "Step 5 - Final Answer",
                description: "Model generates the final answer based on truncated context.",
                budgetCheckText: "Finished",
                tokensUsed: 1024,
                showQuestion: true,
                content: [
                    { type: 'tag', text: '<think>' },
                    { type: 'content', title: 'Truncated Reasoning', tokens: 1024 },
                    { type: 'tag', text: '</think>' },
                    { type: 'tag', text: 'So, the final answer is' },
                    { type: 'answer', title: 'Final Answer', tooltip: "Answer generated from partial reasoning" }
                ],
                isComplete: true
            }
        ];

        let currentIndex = 0;
        let isPlaying = false;
        let animationInterval = null;
        const STEP_DELAY = 1200;

        // Initialization
        function init() {
            // Slider Setup
            const slider = document.getElementById('progressSlider');
            const markersContainer = document.getElementById('stepMarkers');
            const labelsContainer = document.getElementById('stepLabels');
            
            slider.max = stages.length - 1;
            
            // Set limit marker position
            const limitMarker = document.querySelector('.budget-limit-marker');
            if (limitMarker) {
                limitMarker.style.left = `${(BUDGET_LIMIT / SCALE_MAX) * 100}%`;
            }
            
            stages.forEach((stage, index) => {
                // Markers
                const marker = document.createElement('div');
                marker.className = 'marker';
                markersContainer.appendChild(marker);

                // Labels
                const match = stage.iteration.match(/Step ([0-9]+)/);
                const labelText = match ? match[1] : (index + 1);
                
                const label = document.createElement('div');
                label.className = 'step-label';
                label.textContent = labelText;
                label.onclick = () => seek(index);
                label.setAttribute('data-tooltip', stage.description || stage.iteration);
                labelsContainer.appendChild(label);
            });

            renderStage();
        }

        // Core Rendering
        function renderStage() {
            const stage = stages[currentIndex];
            
            // 1. Update Text Info
            document.getElementById('subtitle').textContent = stage.iteration;
            document.getElementById('subtitle').setAttribute('data-tooltip', stage.description || stage.iteration);
            
            // 2. Update Budget Bar
            const budgetFill = document.getElementById('budgetFill');
            const budgetNum = document.getElementById('budgetNumerical');
            const budgetStatus = document.getElementById('budgetStatusText');
            
            // Calculate width percentage relative to SCALE_MAX for visualization purposes
            // This allows us to show "Over budget" by going past the limit marker
            const pct = Math.min(100, (stage.tokensUsed / SCALE_MAX) * 100);
            budgetFill.style.width = `${pct}%`;
            
            // Color logic based on stage
            if (stage.tokensUsed > BUDGET_LIMIT) {
                // Calculate where the limit falls relative to the current width
                // For example if tokensUsed is 1450 (100% width), limit (1024) is at ~70%
                // If tokensUsed is 1100, limit is at (1024/1100) ~93%
                const limitStop = (BUDGET_LIMIT / stage.tokensUsed) * 100;
                budgetFill.style.background = `linear-gradient(90deg, var(--primary) ${limitStop}%, var(--color-wait) ${limitStop}%)`;
            } else {
                budgetFill.style.background = 'var(--primary)'; // Normal
            }
            
            budgetNum.innerHTML = `<strong>${stage.tokensUsed}</strong> / ${BUDGET_LIMIT}`;
            
            // Budget Check Text
            if (stage.budgetCheckText) {
                budgetStatus.textContent = stage.budgetCheckText;
                budgetStatus.classList.add('show');
            } else {
                budgetStatus.classList.remove('show');
            }

            // 3. Visibility of Nodes
            const qNode = document.getElementById('nodeQuestion');
            const mNode = document.getElementById('nodeModel');
            const conn1 = document.getElementById('conn1');
            const conn2 = document.getElementById('conn2');
            const outContainer = document.getElementById('outputContainer');
            const finalBadge = document.getElementById('finalBadge');

            if (stage.showQuestion) {
                qNode.classList.add('visible');
                setTimeout(() => conn1.classList.add('visible'), 100);
                setTimeout(() => mNode.classList.add('visible'), 200);
                setTimeout(() => conn2.classList.add('visible'), 300);
            }

            // 4. Render Content Stream
            const streamBox = document.getElementById('streamContent');
            streamBox.innerHTML = ''; // Clear current
            
            stage.content.forEach((item, idx) => {
                const el = document.createElement('div');
                el.style.animationDelay = `${idx * 0.03}s`; // Stagger animations
                
                if (item.tooltip) {
                    el.setAttribute('data-tooltip', item.tooltip);
                }
                
                if (item.type === 'tag') {
                    el.className = 'item-tag stream-item';
                    el.textContent = item.text;
                } else if (item.type === 'content') {
                    el.className = 'item-content stream-item';
                    el.innerHTML = `
                        <strong>${item.title}</strong>
                        <span class="meta">${item.tokens} tokens</span>
                    `;
                } else if (item.type === 'wait') {
                    el.className = 'item-wait stream-item';
                    el.innerHTML = `✂️ ${item.text} ✂️`;
                } else if (item.type === 'answer') {
                    el.className = 'item-answer stream-item';
                    el.innerHTML = `
                        <span class="label">Final Output</span>
                        ${item.title}
                    `;
                }
                streamBox.appendChild(el);
            });

            // 5. Container State
            if (stage.isComplete) {
                outContainer.classList.add('final-state');
                finalBadge.classList.add('visible');
            } else {
                outContainer.classList.remove('final-state');
                finalBadge.classList.remove('visible');
            }

            // 6. Update Slider UI
            document.getElementById('progressSlider').value = currentIndex;
            
            // Update active label
            document.querySelectorAll('.step-label').forEach((lbl, idx) => {
                if (idx === currentIndex) lbl.classList.add('active');
                else lbl.classList.remove('active');
            });
        }

        // Logic Control
        function seek(val) {
            if (isPlaying) togglePlayPause();
            currentIndex = parseInt(val);
            renderStage();
        }

        function togglePlayPause() {
            const btn = document.getElementById('playPauseBtn');
            
            if (isPlaying) {
                isPlaying = false;
                clearInterval(animationInterval);
                btn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Start';
                btn.classList.remove('active'); // Optional style
            } else {
                isPlaying = true;
                btn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg> Pause';
                
                if (currentIndex === stages.length - 1) {
                    currentIndex = 0;
                    renderStage();
                }
                
                animationInterval = setInterval(() => {
                    currentIndex++;
                    if (currentIndex >= stages.length) {
                        currentIndex = 0; // Loop or stop? Let's loop
                    }
                    renderStage();
                }, STEP_DELAY);
            }
        }

        function resetDemo() {
            isPlaying = false;
            clearInterval(animationInterval);
            currentIndex = 0;
            document.getElementById('playPauseBtn').innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Start';
            renderStage();
        }

        // Run
        init();

    </script>
</body>
</html>

